name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'opened' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude'))) ||
      (github.event_name == 'issues' && github.event.action == 'assigned' && github.event.assignee.login == 'claude')
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Extract model from trigger
        id: extract_model
        env:
          COMMENT_BODY: ${{ github.event.comment.body || '' }}
          ISSUE_BODY: ${{ github.event.issue.body || '' }}
          ISSUE_TITLE: ${{ github.event.issue.title || '' }}
          REVIEW_BODY: ${{ github.event.review.body || '' }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          # Get the trigger body based on event type (using env vars for safety)
          if [ "$EVENT_NAME" = "issue_comment" ] || [ "$EVENT_NAME" = "pull_request_review_comment" ]; then
            BODY="$COMMENT_BODY"
          elif [ "$EVENT_NAME" = "pull_request_review" ]; then
            BODY="$REVIEW_BODY"
          elif [ "$EVENT_NAME" = "issues" ]; then
            BODY="$ISSUE_BODY $ISSUE_TITLE"
          fi

          # Extract model from @claude:model pattern (default: opus)
          # Only match valid model names to prevent injection
          MODEL=$(echo "$BODY" | grep -oE '@claude:(opus|sonnet|haiku)' | head -1 | cut -d: -f2 || true)

          # Validate and default to opus
          case "$MODEL" in
            opus|sonnet|haiku) ;;
            *) MODEL="opus" ;;
          esac

          echo "model=$MODEL" >> $GITHUB_OUTPUT
          echo "Selected model: $MODEL"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.3'

      - name: Install dependencies
        run: bun install

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          model: ${{ steps.extract_model.outputs.model }}
          assignee_trigger: "claude"
          allowed_tools: "Bash,Read,Write,Edit,WebSearch"
          claude_env: |
            CLAUDE_CODE_MAX_OUTPUT_TOKENS=50000
            BASH_DEFAULT_TIMEOUT_MS=120000
            CI=true
