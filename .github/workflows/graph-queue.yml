# Graph Issue Queue Workflow
#
# This workflow demonstrates the sys/graph library by processing GitHub issues
# through a queue-based execution system.
#
# Flow:
# 1. Orchestrator: Uses dispatch workflow to find ready issues
# 2. Process: Matrix job runs issue-processor workflow for each ready issue
#
# Supports two source types:
# - 'label': Fetch issues by label
# - 'project': Fetch issues from GitHub Projects V2 by status column
#
# Trigger: Manual (workflow_dispatch) only for initial testing

name: Graph Issue Queue

on:
  workflow_dispatch:
    inputs:
      source:
        description: 'Issue source type'
        required: false
        default: 'project'
        type: choice
        options:
          - label
          - project
      max_concurrent:
        description: 'Maximum concurrent issues'
        required: false
        default: '3'
        type: string

# Permissions required for issue processing, PR creation, and commenting
permissions:
  contents: write
  issues: write
  pull-requests: write

# Hardcoded project configuration
env:
  GRAPH_PROJECT_OWNER: iota-uz
  GRAPH_PROJECT_NUMBER: '14'
  GRAPH_READY_STATUS: Ready
  GRAPH_IN_PROGRESS_STATUS: In Progress
  GRAPH_DONE_STATUS: Done
  GRAPH_BASE_BRANCH: main
  GRAPH_LABEL: queue

jobs:
  # ============================================================================
  # Orchestrator: Find ready issues and build matrix
  # ============================================================================
  orchestrate:
    name: Find Ready Issues
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.dispatch.outputs.matrix }}
      has_issues: ${{ steps.check.outputs.has_issues }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run dispatch workflow
        id: dispatch
        run: bun run graph dispatch.config.ts --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GRAPH_SOURCE: ${{ inputs.source }}
          GRAPH_MAX_CONCURRENT: ${{ inputs.max_concurrent }}
          GRAPH_OUTPUT_FILE: matrix.json

      - name: Check if there are issues to process
        id: check
        run: |
          if [ -f matrix.json ]; then
            MATRIX=$(cat matrix.json)
            if [ "$MATRIX" = '{"include":[]}' ] || [ -z "$MATRIX" ]; then
              echo "has_issues=false" >> $GITHUB_OUTPUT
              echo "No issues ready for processing"
            else
              echo "has_issues=true" >> $GITHUB_OUTPUT
              echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
              echo "Found issues to process"
            fi
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo "No matrix file found"
          fi

      - name: Upload matrix artifact
        if: steps.check.outputs.has_issues == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dispatch-matrix
          path: matrix.json
          retention-days: 1

  # ============================================================================
  # Process: Run graph workflow for each ready issue
  # ============================================================================
  process:
    name: Process Issue ${{ matrix.issue_number }}
    needs: orchestrate
    if: needs.orchestrate.outputs.has_issues == 'true'
    runs-on: ubuntu-latest

    strategy:
      matrix: ${{ fromJson(needs.orchestrate.outputs.matrix) }}
      fail-fast: false  # Continue processing other issues if one fails
      max-parallel: 3

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Add processing comment to issue
        run: |
          gh issue comment ${{ matrix.issue_number }} --body "## Processing Started

          This issue is being processed by the **Graph Issue Queue** workflow.

          - **Workflow Run:** [View](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **Started:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ---
          *Automated by sys/graph workflow engine*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run issue processor workflow
        id: workflow
        run: bun run graph issue-processor.config.ts --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GRAPH_ISSUE_NUMBER: ${{ matrix.issue_number }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
        continue-on-error: true

      - name: Report success
        if: steps.workflow.outcome == 'success'
        run: |
          gh issue comment ${{ matrix.issue_number }} --body "## Processing Complete

          The graph workflow has finished processing this issue.

          - **Status:** Success
          - **Duration:** ${{ job.duration || 'N/A' }}
          - **Workflow Run:** [View](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          Please review any changes made and provide feedback.

          ---
          *Automated by sys/graph workflow engine*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Report failure
        if: steps.workflow.outcome == 'failure'
        run: |
          gh issue comment ${{ matrix.issue_number }} --body "## Processing Failed

          The graph workflow encountered an error while processing this issue.

          - **Status:** Failed
          - **Workflow Run:** [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          Please check the workflow logs for details.

          ---
          *Automated by sys/graph workflow engine*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Summary: Report overall results
  # ============================================================================
  summary:
    name: Workflow Summary
    needs: [orchestrate, process]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate summary
        run: |
          echo "## Graph Issue Queue Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Source | \`${{ inputs.source }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Max Concurrent | ${{ inputs.max_concurrent }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Has Issues | ${{ needs.orchestrate.outputs.has_issues }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.orchestrate.outputs.has_issues }}" == "true" ]; then
            echo "### Issues Processed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Matrix:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            echo '${{ needs.orchestrate.outputs.matrix }}' | jq '.' >> $GITHUB_STEP_SUMMARY || echo '${{ needs.orchestrate.outputs.matrix }}' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "No issues were ready for processing." >> $GITHUB_STEP_SUMMARY
          fi
