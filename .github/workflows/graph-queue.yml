# Graph Issue Queue Workflow
#
# This workflow demonstrates the sys/graph library by processing GitHub issues
# through a queue-based execution system.
#
# Flow:
# 1. Orchestrator: Uses dispatch CLI to find ready issues
# 2. Process: Matrix job runs graph workflow for each ready issue
#
# Supports two source types:
# - 'label': Fetch issues by label (default)
# - 'project': Fetch issues from GitHub Projects V2 by status column
#
# Trigger: Manual (workflow_dispatch) only for initial testing

name: Graph Issue Queue

on:
  workflow_dispatch:
    inputs:
      source:
        description: 'Issue source type'
        required: false
        default: 'label'
        type: choice
        options:
          - label
          - project
      label:
        description: 'Issue label (for label source)'
        required: false
        default: 'queue'
        type: string
      project_owner:
        description: 'Project owner (for project source)'
        required: false
        default: ''
        type: string
      project_number:
        description: 'Project number (for project source)'
        required: false
        default: ''
        type: string
      ready_status:
        description: 'Status to filter by (for project source)'
        required: false
        default: 'Ready'
        type: string
      in_progress_status:
        description: 'Status to set when processing (for project source)'
        required: false
        default: 'In Progress'
        type: string
      base_branch:
        description: 'Target branch for PRs'
        required: false
        default: 'main'
        type: choice
        options:
          - main
          - develop
          - staging
      max_concurrent:
        description: 'Maximum concurrent issues'
        required: false
        default: '3'
        type: string

# Permissions required for issue processing, PR creation, and commenting
permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # ============================================================================
  # Orchestrator: Find ready issues and build matrix
  # ============================================================================
  orchestrate:
    name: Find Ready Issues
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.dispatch.outputs.matrix }}
      has_issues: ${{ steps.check.outputs.has_issues }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run dispatch to find ready issues
        id: dispatch
        run: |
          # Build dispatch command based on source type
          DISPATCH_CMD="bun run dispatch --source ${{ inputs.source }}"

          if [ "${{ inputs.source }}" = "project" ]; then
            # Project source: use project-specific options
            if [ -n "${{ inputs.project_owner }}" ]; then
              DISPATCH_CMD="$DISPATCH_CMD --project-owner ${{ inputs.project_owner }}"
            fi
            if [ -n "${{ inputs.project_number }}" ]; then
              DISPATCH_CMD="$DISPATCH_CMD --project-number ${{ inputs.project_number }}"
            fi
            if [ -n "${{ inputs.ready_status }}" ]; then
              DISPATCH_CMD="$DISPATCH_CMD --ready-status \"${{ inputs.ready_status }}\""
            fi
            if [ -n "${{ inputs.in_progress_status }}" ]; then
              DISPATCH_CMD="$DISPATCH_CMD --in-progress \"${{ inputs.in_progress_status }}\""
            fi
          else
            # Label source: use label option
            DISPATCH_CMD="$DISPATCH_CMD --label \"${{ inputs.label }}\""
          fi

          # Add common options
          DISPATCH_CMD="$DISPATCH_CMD --max-concurrent ${{ inputs.max_concurrent }} --output matrix.json --verbose"

          echo "Running: $DISPATCH_CMD"
          eval $DISPATCH_CMD

          # Read matrix and set output
          if [ -f matrix.json ]; then
            echo "matrix=$(cat matrix.json)" >> $GITHUB_OUTPUT
          else
            echo 'matrix={"include":[]}' >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if there are issues to process
        id: check
        run: |
          MATRIX='${{ steps.dispatch.outputs.matrix }}'
          if [ "$MATRIX" = '{"include":[]}' ] || [ -z "$MATRIX" ]; then
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo "No issues ready for processing"
          else
            echo "has_issues=true" >> $GITHUB_OUTPUT
            echo "Found issues to process"
          fi

      - name: Upload matrix artifact
        if: steps.check.outputs.has_issues == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dispatch-matrix
          path: matrix.json
          retention-days: 1

  # ============================================================================
  # Process: Run graph workflow for each ready issue
  # ============================================================================
  process:
    name: Process Issue ${{ matrix.issue_number }}
    needs: orchestrate
    if: needs.orchestrate.outputs.has_issues == 'true'
    runs-on: ubuntu-latest

    strategy:
      matrix: ${{ fromJson(needs.orchestrate.outputs.matrix) }}
      fail-fast: false  # Continue processing other issues if one fails
      max-parallel: 3

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Add processing comment to issue
        run: |
          gh issue comment ${{ matrix.issue_number }} --body "## Processing Started

          This issue is being processed by the **Graph Issue Queue** workflow.

          - **Workflow Run:** [View](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **Started:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ---
          *Automated by sys/graph workflow engine*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run graph workflow for issue
        id: workflow
        run: |
          # Build run-issue command
          RUN_CMD="bun run src/lib/graph/cli/run-issue.ts --issue ${{ matrix.issue_number }} --base-branch ${{ inputs.base_branch }}"

          # Add project configuration if using project source
          if [ "${{ inputs.source }}" = "project" ]; then
            if [ -n "${{ inputs.project_owner }}" ]; then
              RUN_CMD="$RUN_CMD --project-owner ${{ inputs.project_owner }}"
            fi
            if [ -n "${{ inputs.project_number }}" ]; then
              RUN_CMD="$RUN_CMD --project-number ${{ inputs.project_number }}"
            fi
          fi

          RUN_CMD="$RUN_CMD --verbose"
          echo "Running: $RUN_CMD"
          eval $RUN_CMD
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
        continue-on-error: true

      - name: Report success
        if: steps.workflow.outcome == 'success'
        run: |
          gh issue comment ${{ matrix.issue_number }} --body "## Processing Complete

          The graph workflow has finished processing this issue.

          - **Status:** Success
          - **Duration:** ${{ job.duration || 'N/A' }}
          - **Workflow Run:** [View](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          Please review any changes made and provide feedback.

          ---
          *Automated by sys/graph workflow engine*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Report failure
        if: steps.workflow.outcome == 'failure'
        run: |
          gh issue comment ${{ matrix.issue_number }} --body "## Processing Failed

          The graph workflow encountered an error while processing this issue.

          - **Status:** Failed
          - **Workflow Run:** [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          Please check the workflow logs for details.

          ---
          *Automated by sys/graph workflow engine*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Summary: Report overall results
  # ============================================================================
  summary:
    name: Workflow Summary
    needs: [orchestrate, process]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate summary
        run: |
          echo "## Graph Issue Queue Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Source | \`${{ inputs.source }}\` |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.source }}" = "project" ]; then
            echo "| Project Owner | \`${{ inputs.project_owner }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Project Number | \`${{ inputs.project_number }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Ready Status | \`${{ inputs.ready_status }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| In Progress Status | \`${{ inputs.in_progress_status }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Label | \`${{ inputs.label }}\` |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| Base Branch | \`${{ inputs.base_branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Max Concurrent | ${{ inputs.max_concurrent }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Has Issues | ${{ needs.orchestrate.outputs.has_issues }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.orchestrate.outputs.has_issues }}" == "true" ]; then
            echo "### Issues Processed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Matrix:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            echo '${{ needs.orchestrate.outputs.matrix }}' | jq '.' >> $GITHUB_STEP_SUMMARY || echo '${{ needs.orchestrate.outputs.matrix }}' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "No issues were ready for processing." >> $GITHUB_STEP_SUMMARY
          fi
